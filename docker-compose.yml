services:
  sova:
    build: .
    container_name: parley-chat-sova
    restart: "unless-stopped"
    volumes:
      - ./config.toml:/app/config.toml
      - ./data:/app/data
      - ../Mura:/Mura
      - ./legal:/app/legal
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - parley-chat-network
    expose:
      - "42835"
    healthcheck: # The health check URL must contain the URI Path if set in config.toml
      test: ["CMD", "curl", "-f", "http://localhost:42835/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  nginx:
    image: nginx:alpine
    container_name: parley-chat-nginx
    restart: "unless-stopped"
    ports:
      - "${PORT:-42835}:42835"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      sova:
        condition: service_healthy
    networks:
      - parley-chat-network

networks:
  parley-chat-network:
    driver: bridge
